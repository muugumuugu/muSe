let frm,searchable=!1,fs=!1,dropbox,stashurl,loadbtn,btn,shuffling=!1,txt,m3u=[],playlist=[],player,currSong=-1;function setup(){noCanvas(),0<window.location.href.search(/\?=search/)&&(searchable=!0),frm=document.getElementById("folders"),stashurl=frm.src,searchable&&(stashurl="../php/jukebox.php"),frm.src=stashurl,player=document.getElementById("song"),btn=document.createElement("a"),loadbtn=createFileInput(loadPlaylist),loadbtn.parent(select("#load")),btn.innerHTML="&nbsp;<<&nbsp;",btn.href=stashurl,btn.id="btn",dropbox=document.getElementById("dropbox"),txt=document.getElementById("txt"),player.onended=function(){playnext()}}function playselected(){sels=select("#dropbox").selected(),0<sels.length&&player.paused&&(player.src=sels[0])}function draw(){translate(width/2,height/2);let e=searchable;if(searchable||frm.contentWindow.location!=stashurl&&(e=!0),e){let n=frm.contentWindow.document.getElementsByTagName("h1")[0],e=frm.contentWindow.document.getElementsByTagName("ul")[0];e&&(e.style.height=.78*windowHeight+"px",e.style.overflow="auto");let r=frm.contentWindow.document.getElementsByTagName("a");!player.src.match("mp3")&&0<playlist.length&&(currSong=0,player.src=playlist[0]);for(let o=0;o<r.length;o++)r[o].ondragstart=function(){drag(event)},r[o].draggable=!0,r[o].style.userSelect="none",r[o].title=trim(r[o].innerHTML),"btn"!=r[o].id&&(r[o].onclick=function(e){e.preventDefault();let t=document.createElement("option"),n=r[o].href;t.innerHTML=decodeURI(n.replace(/.*\//,"")),t.value=n,t.style.userSelect="all",dropbox.add(t);const l=dropbox.options.length-1;return!(t.ondblclick=function(){playSong(l)})},r[o].dblclick=function(e){r[o].onclick(e)},r[o].ontouchstart=function(e){return e.preventDefault(),!1},r[o].ontouchend=function(e){e.preventDefault();let t=document.createElement("option"),n=r[o].href;t.innerHTML=decodeURI(n.replace(/.*\//,"")),t.value=n,t.style.userSelect="all",dropbox.add(t);const l=dropbox.options.length-1;return!(t.ondblclick=function(){playSong(l)})});if(n){let e=n.innerHTML;e.match("href")||(n.innerHTML="",n.appendChild(btn),n.innerHTML+=e);let t=n.getElementsByTagName("a")[0];t.style.background="transparent",t.style.borderRadius="30px",t.style.padding="4px",t.style.color="white",t.style.border="groove",t.style.borderColor="black",t.style.textDecoration="none",t.style.marginRight="50px"}searchable&&(frm.contentWindow.document.getElementsByTagName("audio")[0].onplay=function(){frm.contentWindow.document.getElementsByTagName("audio")[0].pause()},frm.contentWindow.document.getElementsByTagName("audio")[0].frm.contentWindow.document.getElementsByTagName("audio")[0].style.visibility="hidden")}let t=document.getElementsByTagName("option");for(let e=0;e<t.length;e++)playlist[e]=t[e].value.replace(/^.*muSe/,"..");playlist.length>t.length&&(playlist.length=t.length)}function mixit(){shuffling=!shuffling}function vizIt(){let t={dat:[]};for(let e=0;e<dropbox.options.length;e++)t.dat.push(decodeURI(dropbox.options[e].value));window.location.href=window.location.href.replace(/builder\.html/,"play.html?playlist=")+JSON.stringify(t)}function del(){for(let e=0;e<dropbox.options.length;e++)dropbox.options[e].selected&&dropbox.remove(e,null);currSong>dropbox.length&&(currSong=-1);for(let t=0;t<dropbox.options.length;t++){let e=dropbox[t];e.ondblclick=function(){playSong(t),e.scrollIntoView()},e.style.userSelect="all"}}function remDup(){playlist=[...new Set(playlist)],dropbox.innerHTML="";for(let t=0;t<playlist.length;t++){let e=document.createElement("option");url=playlist[t],e.innerHTML=decodeURI(url.replace(/.*\//,"")),e.value=url,dropbox.add(e),e.ondblclick=function(){playSong(t),e.scrollIntoView()},e.style.userSelect="all"}}function savePlaylist(){let t=["#EXTM3U"];if(select("#online").checked())for(let e=0;e<dropbox.options.length;e++)t.push("#EXTINF: "+dropbox.options[e].innerHTML),t.push(decodeURI(playlist[e].replace(/\.\.\//,window.document.URL.replace(/html\/builder\.html/,""))));else for(let e=0;e<dropbox.options.length;e++)t.push("#EXTINF: "+dropbox.options[e].innerHTML),t.push(decodeURI(playlist[e].replace(/\.\.\//,"/home/Desktop/muSe/")));var e=txt.value;saveStrings(t,e,"m3u")}function highlight(e){dropbox.options[e].style.textShadow="0px 0px 4px yellow",dropbox.options[e].scrollIntoView()}function unhighlight(e){e>=playlist.length&&(e=0),dropbox.options[e].style.textShadow="0px 0px 4px blue,0px 0px 6px blue"}function loadPlaylist(e){e&&(fetch(e.data).then(e=>e.blob()).then(e=>{console.log(e);e.text();e.text().then(e=>{m3u=parseplaylist(e.split("\n")),playlist.push(...onlylinks(m3u)),remDup()});e.text()}),txt.value=e.name.replace(/\.m3u$/,""))}function onlylinks(t){for(let e=0;e<t.length;e++)t[e]=t[e][1].replace(/^music/,"../music");return t}function allowDrop(e){e.preventDefault()}function drag(e){e.dataTransfer.setData("text/plain",e.target.href)}function drop(e){let t=document.createElement("option");e.preventDefault();let n=e.dataTransfer.getData("text/plain");t.innerHTML=decodeURI(n.replace(/.*\//,"")),t.value=n,t.style.userSelect="all",e.target.add(t);const l=dropbox.options.length-1;return!(t.ondblclick=function(){playSong(l),t.scrollIntoView()})}function keyPressed(){switch(console.log(key),keyCode){case ENTER:for(let e=0;e<dropbox.options.length;e++)if(dropbox.options[e].selected)return void playSong(e);case RIGHT_ARROW:return void playnext();case LEFT_ARROW:return void playprev();case 32:return void(player.paused?player.play():player.pause())}}function playnext(){0<playlist.length&&(unhighlight(currSong),shuffling?currSong=Math.floor(Math.random()*playlist.length):(currSong+=1,currSong%=playlist.length),player.src=playlist[currSong],player.play(),highlight(currSong),document.title=dropbox.options[currSong].innerHTML.replace(/.*_\s*/,""))}function playprev(){0<playlist.length&&(unhighlight(currSong),shuffling?currSong=Math.floor(Math.random()*playlist.length):(currSong+=playlist.length-1,currSong%=playlist.length),player.src=playlist[currSong],player.play(),highlight(currSong),document.title=dropbox.options[currSong].innerHTML.replace(/.*_\s*/,""))}function playSong(e){pp=dropbox.options[e],-1<currSong&&unhighlight(currSong),player.src=pp.value,document.title=pp.innerHTML.replace(/.*_\s*/,""),currSong=e,highlight(currSong),player.play()}function fullscreenit(e){fs=!fs,fs?(document.getElementById("sub").style.display="none",document.getElementById("main").style.width="100%",select("#fs").html("EDITOR")):(document.getElementById("sub").style.display="block",document.getElementById("main").style.width="45%",select("#fs").html("FULLSCREEN"))}